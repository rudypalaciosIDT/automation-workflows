name: Deploy Release

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "owner/repo del repo objetivo"
        required: true
      main_branch:
        description: "Branch de producciÃ³n"
        required: false
        default: "master"
      release_branch:
        description: "Branch de staging/release"
        required: false
        default: "nextrelease"
      develop_branch:
        description: "Branch de QA"
        required: false
        default: "nextrelease_qa"

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # Create GitHub App Token
      # ---------------------------------------------------------
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      # ---------------------------------------------------------
      # Validate access to target repo
      # ---------------------------------------------------------
      - name: Verify Repo Access
        id: verify
        env:
          TOKEN: ${{ steps.app_token.outputs.token }}
        run: |
          echo "ðŸ” Verificando acceso al repo: ${{ github.event.inputs.repo_url }}"

          STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.event.inputs.repo_url }})

          if [[ "$STATUS" != "200" ]]; then
            echo "âŒ ERROR: La GitHub App no tiene permiso para acceder al repo."
            echo "Status HTTP recibido: $STATUS"
            exit 1
          fi

          echo "âœ… Acceso confirmado al repo remoto."

      # ---------------------------------------------------------
      # Checkout target repo
      # ---------------------------------------------------------
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repo_url }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0
          path: repo

      # ---------------------------------------------------------
      # Fetch tags
      # ---------------------------------------------------------
      - name: Fetch tags
        working-directory: repo
        run: git fetch --tags --force

      # ---------------------------------------------------------
      # Detect latest version tag
      # ---------------------------------------------------------
      - name: Detect version
        id: detect
        working-directory: repo
        run: |
          version=$(git describe --tags --abbrev=0)
          echo "Found version: $version"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      # ---------------------------------------------------------
      # Deploy release (embedded shell script)
      # ---------------------------------------------------------
      - name: Deploy release
        working-directory: repo
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          RELEASE_VERSION: ${{ steps.detect.outputs.version }}
          MAIN_BRANCH: ${{ github.event.inputs.main_branch }}
          RELEASE_BRANCH: ${{ github.event.inputs.release_branch }}
          DEVELOP_BRANCH: ${{ github.event.inputs.develop_branch }}
          REPO_URL: ${{ github.event.inputs.repo_url }}
        run: |
          set -euo pipefail

          echo "Merging $RELEASE_BRANCH â†’ $MAIN_BRANCH"
          git checkout "$MAIN_BRANCH"
          git pull origin "$MAIN_BRANCH"
          git merge --no-ff "$RELEASE_BRANCH" -m "Deploy $RELEASE_VERSION"
          git push origin "$MAIN_BRANCH"

          echo "Merging $MAIN_BRANCH â†’ $DEVELOP_BRANCH"
          git checkout "$DEVELOP_BRANCH"
          git pull origin "$DEVELOP_BRANCH"
          git merge --no-ff "$MAIN_BRANCH" -m "Sync after deploy $RELEASE_VERSION"
          git push origin "$DEVELOP_BRANCH"

          echo "Publishing GitHub Release $RELEASE_VERSION"
          curl -X PATCH \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO_URL/releases/tags/$RELEASE_VERSION \
            -d '{"draft":false}'

          echo "âœ” Deployment complete."

      - name: Done
        run: echo "ðŸŽ‰ Deploy pipeline finished successfully."
