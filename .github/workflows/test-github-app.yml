name: Test GitHub App token + checkout

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Repo objetivo (org/repo) para probar checkout'
        required: true
        default: '<tu-usuario>/<tu-repo-de-prueba>'
      version_type:
        description: 'patch | minor | major'
        required: false
        default: 'patch'

jobs:
  test-app-token:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout automation-workflows
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate GitHub App token
        id: app_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Show token prefix (debug only)
        run: |
          echo "Token length: ${{ steps.app_token.outputs.token }}" >/dev/null || true
          if [ -z "${{ steps.app_token.outputs.token }}" ]; then
            echo "No token returned" && exit 1
          fi
          echo "Token appears generated."

      - name: Checkout target repo using App token (into subdir)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo }}
          token: ${{ steps.app_token.outputs.token }}
          fetch-depth: 0
          path: target-repo

      - name: Show current repo info (sanity)
        run: |
          echo "Checked out automation-workflows (workspace):"
          ls -la "$GITHUB_WORKSPACE"
          echo
          echo "Checked out target repo (target-repo):"
          ls -la "$GITHUB_WORKSPACE/target-repo"
          echo "Current branch (automation-workflows): $(git -C "$GITHUB_WORKSPACE" rev-parse --abbrev-ref HEAD || echo none)"

      - name: Run prepare_release_test script (from automation-workflows)
        run: bash "$GITHUB_WORKSPACE/scripts/prepare_release_test.sh" "${{ github.event.inputs.version_type }}"
