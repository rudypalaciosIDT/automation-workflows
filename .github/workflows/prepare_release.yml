name: 1. Release Cut (Remote Repo)

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Target repo (format: owner/name)"
        required: true
        type: string

      version_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

      develop_branch:
        description: "QA branch (base branch for RC)"
        required: true
        default: "nextrelease_qa"
        type: string

jobs:
  prepare_release:
    runs-on: ubuntu-latest

    env:
      TEMPORARY_RELEASE_BRANCH: release/candidate

    steps:
      - name: Generate App JWT
        id: app_jwt
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Lookup installation for the repo owner
        id: lookup
        run: |
          OWNER=$(echo "${{ inputs.repo_url }}" | cut -d'/' -f1)

          installation_id=$(curl -s \
            -H "Authorization: Bearer ${{ steps.app_jwt.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations \
          | jq -r ".[] | select(.account.login==\"$OWNER\") | .id")

          if [ -z "$installation_id" ] || [ "$installation_id" = "null" ]; then
            echo "::error ::No installation found for owner: $OWNER"
            exit 1
          fi

          echo "installation_id=$installation_id" >> $GITHUB_OUTPUT

      - name: Generate Installation Token
        id: installation_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
          installation_id: ${{ steps.lookup.outputs.installation_id }}

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_url }}
          token: ${{ steps.installation_token.outputs.token }}
          fetch-depth: 0

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_url }}
          token: ${{ steps.installation_token.outputs.token }}
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config user.name "${{ vars.APP_SLUG }}[bot]"
          git config user.email "${{ secrets.APP_ID }}+${{ vars.APP_SLUG }}[bot]@users.noreply.github.com"

      - name: Checkout develop branch
        run: |
          git checkout ${{ inputs.develop_branch }}

      - name: Delete temporary release branch if exists
        run: |
          if git rev-parse --verify "$TEMPORARY_RELEASE_BRANCH" >/dev/null 2>&1; then
            echo "[WARN] Branch exists, deleting..."
            git branch -D "$TEMPORARY_RELEASE_BRANCH"
          fi

      - name: Create RC branch
        run: |
          git checkout -b "$TEMPORARY_RELEASE_BRANCH"

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Bump version to next RC
        id: bump
        env:
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
        run: |
          rc_version=$(npm version pre${VERSION_TYPE} --preid=rc)
          echo "rc_version=$rc_version" >> $GITHUB_OUTPUT

      - name: Push branch and tags
        run: |
          git push origin "$TEMPORARY_RELEASE_BRANCH" --follow-tags

      - name: Success message
        run: echo "[OK] Release Candidate ${{ steps.bump.outputs.rc_version }} created and pushed!"
