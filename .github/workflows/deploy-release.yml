name: Deploy Release

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "owner/repo del repo objetivo"
        required: true
      main_branch:
        description: "Branch de producciÃ³n"
        default: "master"
      release_branch:
        description: "Branch de staging/release"
        default: "nextrelease"
      develop_branch:
        description: "Branch QA"
        default: "nextrelease_qa"

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: app_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repo_url }}
          token: ${{ steps.app_token.outputs.token }}
          fetch-depth: 0
          path: repo

      - name: Fetch tags
        working-directory: repo
        run: git fetch --tags --force

      - name: Configure git identity
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "Automation Bot"

      - name: Deploy release
        working-directory: repo
        env:
          GH_TOKEN: ${{ steps.app_token.outputs.token }}
          REPO_URL: ${{ github.event.inputs.repo_url }}
          MAIN: ${{ github.event.inputs.main_branch }}
          RELEASE: ${{ github.event.inputs.release_branch }}
          DEVELOP: ${{ github.event.inputs.develop_branch }}
        run: |
          set -euo pipefail

          echo "Checking version from $RELEASE..."
          git checkout "$RELEASE"
          git pull origin "$RELEASE"
          VERSION=$(git describe --tags --abbrev=0)
          echo "VERSION=$VERSION"

          # ---------------------------
          # PR 1: release -> main
          # ---------------------------
          echo "Creating PR: $RELEASE â†’ $MAIN"

          PR1=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO_URL/pulls \
            -d "{
              \"title\": \"Deploy $VERSION to $MAIN\",
              \"base\": \"$MAIN\",
              \"head\": \"$RELEASE\"
            }" | jq -r .number)

          if [[ "$PR1" == "null" ]]; then
            echo "ERROR creating PR1"
            exit 1
          fi

          echo "Auto-merging PR #$PR1..."
          curl -s -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO_URL/pulls/$PR1/merge \
            -d '{"merge_method":"merge"}'

          # ---------------------------
          # PR 2: main -> develop
          # ---------------------------
          git fetch
          echo "Creating PR: $MAIN â†’ $DEVELOP"

          PR2=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO_URL/pulls \
            -d "{
              \"title\": \"Sync post-deploy $VERSION\",
              \"base\": \"$DEVELOP\",
              \"head\": \"$MAIN\"
            }" | jq -r .number)

          if [[ "$PR2" == "null" ]]; then
            echo "ERROR creating PR2"
            exit 1
          fi

          echo "Auto-merging PR #$PR2..."
          curl -s -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO_URL/pulls/$PR2/merge \
            -d '{"merge_method":"merge"}'

          # ---------------------------
          # Publish Release
          # ---------------------------
          echo "Publishing GitHub Release $VERSION"

          RELEASE_ID=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO_URL/releases/tags/$VERSION" \
            | jq -r '.id')

          curl -X PATCH \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO_URL/releases/$RELEASE_ID" \
            -d '{"draft": false, "prerelease": false, "make_latest": true}'

          echo "âœ” Deployment complete for $VERSION"

      - name: Done
        run: echo "ðŸŽ‰ Deploy finished successfully."
